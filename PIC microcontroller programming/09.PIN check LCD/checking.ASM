#INCLUDE <P16F877A.INC>
LIST P=16F877A
ORG 0X20
;OHM GAM GANAPATAYE NAMAH

;;;;;;;;;;;;;;;;;;;;;;;
MOVLW 0X90
MOVWF RCSTA
BSF STATUS,RP0
MOVLW 0XFF
MOVWF SPBRG
MOVLW 0X24
MOVWF TXSTA
BCF STATUS,RP0
BSF RCSTA,SPEN
;;;;;;;;;;;;;;;;;;;;;;;;
BSF STATUS,RP0
MOVLW 0XF0
MOVWF TRISB
BCF TRISC,0
BCF TRISC,1
BCF TRISC,2
MOVLW 0X00
MOVWF TRISA
MOVWF TRISD
MOVWF TRISE
MOVLW 0X06
MOVWF ADCON1
BCF OPTION_REG,7  ;PORTB PULLUPS ENABLED
BCF STATUS,RP0
MOVLW 0X00
MOVWF 0X50
MOVWF PORTE
BSF PORTC,0; 
BCF PORTC,1; WRITE MODE
BSF PORTC,2;E=1
CALL DELAY
BCF PORTC,0
CALL DELAY
MOVLW 0X0F
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY
MOVLW 0X38
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2

GOTO OUTPUT_NULL

;----------------------------------------------------------
; INTIALISING FOR SCANNING KEYPAD
;----------------------------------------------------------
GET_IT
;OLD_KEY=0X40
;NEW_KEY=0X41
;COUNT=0X42
;DATA_COUNT=0X50

;----------------------------
; CHECKING PIN ENTERED
;----------------------------
MOVF RCREG,0
MOVWF PORTA
MOVLW 0X0A
SUBWF PORTA,0
BTFSC STATUS,Z
GOTO ACCEPTED

MOVLW 0X0D
SUBWF PORTA,0
BTFSC STATUS,Z
GOTO DENIED
;----------------------------

MOVF 0X50,0
MOVLW 0X00        
MOVWF 0X40      ;OLD_KEY=0
MOVWF 0X41      ;NEW_KEY=0
GET_IT_SUBLOOP
MOVLW 0X00
MOVWF 0X42      ;COUNT=0
GET_IT_SUBLOOP2
CALL SCAN_IT
MOVF 0X22,0
MOVWF 0X41      ;MOVING KEY_VALUE TO NEW_KEY
SUBWF 0X40,0     ;W<--OLD_KEY-NEW_KEY
BTFSS STATUS,2
GOTO ASSIGN_NEW_TO_OLD
INCF 0X42,1
CALL DELAY
BTFSS STATUS,2
GOTO GET_IT_SUBLOOP2
GOTO AFTER_SCAN_IT

ASSIGN_NEW_TO_OLD
MOVF 0X41,0
MOVWF 0X40
GOTO GET_IT_SUBLOOP

;----------------------------------------------------------
;STARTING OF SCAN_IT
;----------------------------------------------------------

SCAN_IT

MOVLW 0X01 
MOVWF 0X20       ;0X20 IS THE KEY_COUNT VARIABLE
MOVLW 0XF7
MOVWF 0X21       ;0X21 IS THE PATTERN TO BE GIVEN TO PORTB
    SUB_LOOP
	MOVF 0X21,0
	MOVWF PORTB  ;OUTPUT 'PATTERN' TO PORTB
	MOVF 0X20,0 ;W=KEY_COUNT
	BTFSS PORTB,7
	GOTO SCAN_IT_FINISH
    ADDLW 0X03
	BTFSS PORTB,6
    GOTO SCAN_IT_FINISH
    ADDLW 0X03
	BTFSS PORTB,5
	GOTO SCAN_IT_FINISH
    ADDLW 0X03
	BTFSS PORTB,4
	GOTO SCAN_IT_FINISH
    MOVLW 0XFF          ;THESE STEPS
    MOVWF 0X30     
    INCF 0X30,1         ;USED TO SET CARRY FOR THE RIGHT SHIFT
    MOVLW 0XFF          ;MOVING A MARKER TO W TO SHOW NO KEY PRESSED ON THE COLUMN
	INCF 0X20,1         ;INCREMENT KEY_COUNT
    RRF 0X21,1          ;SHIFT PATTERN RIGHT
    BTFSC 0X21,0        ;CHECKING IF PATTERN(0) IS CLEAR
    GOTO SUB_LOOP       ;CHECK NXT COLUMN IF PATTERN(0) IS STILL 1
SCAN_IT_FINISH

MOVWF 0X22   ;0X22 WILL HAVE THE KEYVALUE,FF-->NO READ ; 
RETURN
;FINISHING OF SCAN_IT
AFTER_SCAN_IT
MOVF 0X40,0 ;W<--OLD_KEY
MOVWF 0X30
INCF 0X30,1 ;CHECKING IF THE CONTINUOUSLY OCCURED VALUE WAS FF(IE. NO READ)
BTFSC STATUS,2
GOTO GET_IT
GOTO CHECK_ROUTINE
;STARTING OF DATA STORAGE ALGORITHM

CHECK_ROUTINE
MOVF 0X40,0
SUBLW 0X0A
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO KEY_IS_STAR
MOVF 0X40,0
SUBLW 0X0B
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO KEY_IS_ZERO
MOVF 0X40,0

GOTO REG_SETTER

KEY_IS_STAR
MOVF 0X50,0
BTFSC STATUS,2
GOTO GET_IT
DECF 0X50,1
GOTO OUTPUT_SETTER

KEY_IS_ZERO
MOVF 0X50,0
SUBLW 0X04
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
CLRF 0X50
INCF 0X50,1
MOVLW 0X00
MOVWF 0X40
MOVWF 0X41
MOVF 0X50,0
SUBLW 0X01
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO LOC_AT_ONE
MOVF 0X50,0
SUBLW 0X02
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO LOC_AT_TWO
MOVF 0X50,0
SUBLW 0X03
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO LOC_AT_THREE
MOVF 0X50,0
SUBLW 0X04
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO LOC_AT_FOUR

LOC_AT_ONE
;MOVF 0X40,0
MOVLW 0X65
MOVWF 0X70
GOTO OUTPUT_SETTER

LOC_AT_TWO
;MOVF 0X40,0
MOVLW 0X65
MOVWF 0X71
GOTO OUTPUT_SETTER

LOC_AT_THREE
;MOVF 0X40,0
MOVLW 0X65
MOVWF 0X72
GOTO OUTPUT_SETTER

LOC_AT_FOUR
;MOVF 0X40,0
MOVLW 0X65
MOVWF 0X73
GOTO OUTPUT_SETTER

REG_SETTER
MOVF 0X50,0
SUBLW 0X04
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
CLRF 0X50
INCF 0X50,1
MOVF 0X50,0
SUBLW 0X01
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO LOC_AT_ONE
MOVF 0X50,0
SUBLW 0X02
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO LOC_AT_TWO
MOVF 0X50,0
SUBLW 0X03
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO LOC_AT_THREE
MOVF 0X50,0
SUBLW 0X04
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO LOC_AT_FOUR

;----------------------------------------------------------
; OUTPUTING PIN ON THE LCD
;            AND
; ENABLING SERIAL TRANSMISSION
;----------------------------------------------------------

OUTPUT_SETTER

;----------------------------------------------------------
; SERIAL TRANSMISSION
;---------------------------------------------------------- 

MOVF 0X40,0
ADDLW 0X30
MOVWF TXREG

;----------------------------------------------------------
; OUTPUTING ENTERED PIN
;----------------------------------------------------------

MOVF 0X50,0
BTFSC STATUS,2
GOTO OUTPUT_NULL
MOVF 0X50,0
SUBLW 0X01
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO OUTPUT_ONE
MOVF 0X50,0
SUBLW 0X02
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO OUTPUT_TWO
MOVF 0X50,0
SUBLW 0X03
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO OUTPUT_THREE
MOVF 0X50,0
SUBLW 0X04
MOVWF 0X30
MOVF 0X30,0
BTFSC STATUS,2
GOTO OUTPUT_FOUR

OUTPUT_ONE
BSF PORTC,2
BCF PORTC,0
CALL DELAY
MOVLW 0X01
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
BSF PORTC,0
CALL DELAY
MOVF 0X70,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
GOTO GET_IT

OUTPUT_TWO
BSF PORTC,2
BCF PORTC,0
CALL DELAY
MOVLW 0X01
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
BSF PORTC,0
CALL DELAY
MOVF 0X70,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY
MOVF 0X71,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
GOTO GET_IT

OUTPUT_THREE
BSF PORTC,2
BCF PORTC,0
CALL DELAY
MOVLW 0X01
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
BSF PORTC,0
CALL DELAY
MOVF 0X70,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY
MOVF 0X71,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY
MOVF 0X72,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
GOTO GET_IT

OUTPUT_FOUR
BSF PORTC,2
BCF PORTC,0
CALL DELAY
MOVLW 0X01
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
BSF PORTC,0
CALL DELAY
MOVF 0X70,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY
MOVF 0X71,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY
MOVF 0X72,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY
MOVF 0X73,0
ADDLW 0X30
MOVLW '*'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
GOTO GET_IT

OUTPUT_NULL
BSF PORTC,2
BCF PORTC,0
CALL DELAY
MOVLW 0X01
MOVWF PORTD
CALL DELAY
BCF PORTC,2
GOTO GET_IT

;----------------------------------------------------------
; TO DISPLAY WEATHER ACCEPTED OR DENIED
;---------------------------------------------------------- 

ACCEPTED:

BSF PORTC,2
BCF PORTC,0
CALL DELAY
MOVLW 0X01
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
BSF PORTC,0
CALL DELAY2

MOVLW 'A'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'C'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'C'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'E'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'P'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'T'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
BSF PORTC,0
CALL DELAY2

MOVLW 'E'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
BSF PORTC,0
CALL DELAY2

MOVLW 'D'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW ' '
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW ' '
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW ':'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW ')'
MOVWF PORTD
CALL DELAY
BCF PORTC,2

ACC:
GOTO ACC

;----------------------------------------------------------

DENIED:

BSF PORTC,2
BCF PORTC,0
CALL DELAY
MOVLW 0X01
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
BSF PORTC,0
CALL DELAY2

MOVLW 'D'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'E'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'N'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'I'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'E'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW 'D'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW ' '
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW ' '
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW ':'
MOVWF PORTD
CALL DELAY
BCF PORTC,2
CALL DELAY
BSF PORTC,2
CALL DELAY2

MOVLW '('
MOVWF PORTD
CALL DELAY
BCF PORTC,2

DCC:
GOTO DCC
;----------------------------------------------------------
; EXTRA FUNCTIONS
;----------------------------------------------------------
DELAY:
MOVLW 0X09
MOVWF 0X61
D2
MOVLW 0X21
MOVWF 0X60
D1
DECFSZ 0X60,1
GOTO D1
DECFSZ 0X61,1
GOTO D2
RETURN

DELAY2:
MOVLW 0XFF
MOVWF 0X61
D3
MOVLW 0X3F
MOVWF 0X60
D4
DECFSZ 0X60,1
GOTO D4
DECFSZ 0X61,1
GOTO D3
RETURN

;----------------------------------------------------------

END
